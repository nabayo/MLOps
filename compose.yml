services:
  # PostgreSQL - MLflow backend store
  postgres:
    image: postgres:16-alpine
    container_name: mlops-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - mlops-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # MinIO - S3-compatible artifact store
  minio:
    image: minio/minio:latest
    container_name: mlops-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # MinIO Console
    networks:
      - mlops-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped

  # MinIO bucket creator (runs once)
  minio-create-bucket:
    image: minio/mc:latest
    container_name: mlops-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c " mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD}; mc mb myminio/${MINIO_BUCKET_NAME} --ignore-existing; mc anonymous set public myminio/${MINIO_BUCKET_NAME}; exit 0; "
    networks:
      - mlops-network

  # MLflow Tracking Server
  mlflow:
    build:
      context: ./mlflow
      dockerfile: Dockerfile
    container_name: mlops-mlflow
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      minio-create-bucket:
        condition: service_completed_successfully
    environment:
      MLFLOW_BACKEND_STORE_URI: ${MLFLOW_BACKEND_STORE_URI}
      MLFLOW_ARTIFACT_ROOT: ${MLFLOW_ARTIFACT_ROOT}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      MLFLOW_S3_ENDPOINT_URL: ${MLFLOW_S3_ENDPOINT_URL}
    ports:
      - "5000:5000"
    networks:
      - mlops-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # Training Pipeline (run manually or via CI/CD)
  training:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mlops-training
    depends_on:
      mlflow:
        condition: service_healthy
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      MLFLOW_S3_ENDPOINT_URL: ${MLFLOW_S3_ENDPOINT_URL}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./dataset:/app/dataset
      - ./configs:/app/configs
      - ./models:/app/models
      - ./picsellia_token:/app/picsellia_token:ro # Mount token file
      - ./experiments:/app/experiments # Local experiment outputs
      - ./scripts:/app/scripts:ro
      - ./src:/app/src:ro
    networks:
      - mlops-network
    profiles:
      - donotautostart # Only run when explicitly requested

  # Serving API
  serving:
    build:
      context: .
      dockerfile: serving/Dockerfile
    container_name: mlops-serving
    depends_on:
      mlflow:
        condition: service_healthy
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      MLFLOW_S3_ENDPOINT_URL: ${MLFLOW_S3_ENDPOINT_URL}
      DEFAULT_MODEL_NAME: ${DEFAULT_MODEL_NAME:-yolo11-finger-counter}
      DEFAULT_MODEL_STAGE: ${DEFAULT_MODEL_STAGE:-Production}
      ENABLE_PREPROCESSING: ${ENABLE_PREPROCESSING:-true}
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models
    networks:
      - mlops-network
    restart: unless-stopped

  # MLflow Export Service
  export:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mlops-export
    depends_on:
      mlflow:
        condition: service_healthy
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      MLFLOW_S3_ENDPOINT_URL: ${MLFLOW_S3_ENDPOINT_URL}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./backups:/app/backups
      - ./scripts:/app/scripts:ro
    networks:
      - mlops-network
    command: python scripts/export_mlflow.py --output-dir /app/backups
    profiles:
      - tools

  # MLflow Import Service
  import:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mlops-import
    depends_on:
      mlflow:
        condition: service_healthy
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      MLFLOW_S3_ENDPOINT_URL: ${MLFLOW_S3_ENDPOINT_URL}
      BACKUP_FILE: ${BACKUP_FILE:-}
    volumes:
      - ./backups:/app/backups
      - ./scripts:/app/scripts:ro
    networks:
      - mlops-network
    command: >
      bash -c " if [ -z \"$BACKUP_FILE\" ]; then
        echo '‚ùå Error: BACKUP_FILE environment variable not set';
        echo 'Usage: BACKUP_FILE=my_backup.zip docker-compose run --rm import';
        exit 1;
      fi; python scripts/import_mlflow.py /app/backups/$BACKUP_FILE "
    profiles:
      - tools

  # Frontend Dashboard
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: mlops-frontend
    depends_on:
      - serving
    ports:
      - "8080:80"
    networks:
      - mlops-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  minio_data:
    driver: local

networks:
  mlops-network:
    driver: bridge
